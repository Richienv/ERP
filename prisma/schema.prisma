// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ================================
// Authentication & User Management
// ================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("user") // admin, user, manager
  accounts      Account[]
  sessions      Session[]
  
  // Sales relations
  customersAsSalesPerson Customer[]
  assignedLeads          Lead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

// ================================
// Product Categories
// ================================

model Category {
  id          String @id @default(cuid())
  code        String @unique
  name        String
  description String?
  parentId    String?
  isActive    Boolean @default(true)

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

// ================================
// Warehouses & Locations
// ================================

model Warehouse {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  address     String?
  city        String?
  province    String?
  postalCode  String?
  capacity    Int?
  managerId   String?
  isActive    Boolean @default(true)

  locations      Location[]
  stockLevels    StockLevel[]
  stockMovements StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("warehouses")
}

model Location {
  id          String  @id @default(cuid())
  code        String
  name        String
  warehouseId String
  rack        String?
  bin         String?
  aisle       String?
  capacity    Int?
  isActive    Boolean @default(true)

  warehouse      Warehouse       @relation(fields: [warehouseId], references: [id])
  stockLevels    StockLevel[]
  stockMovements StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([warehouseId, code])
  @@map("locations")
}

// ================================
// Products
// ================================

model Product {
  id           String  @id @default(cuid())
  code         String  @unique
  name         String
  description  String?
  categoryId   String?
  unit         String  // pcs, kg, liter, etc
  costPrice    Decimal @default(0) @db.Decimal(15, 2)
  sellingPrice Decimal @default(0) @db.Decimal(15, 2)
  minStock     Int     @default(0)
  maxStock     Int     @default(0)
  reorderLevel Int     @default(0)
  barcode      String?
  isActive     Boolean @default(true)

  category       Category?       @relation(fields: [categoryId], references: [id])
  stockLevels    StockLevel[]
  stockMovements StockMovement[]
  stockAlerts    StockAlert[]
  priceListItems PriceListItem[]
  quotationItems QuotationItem[]
  salesOrderItems SalesOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

// ================================
// Stock Management
// ================================

model StockLevel {
  id           String @id @default(cuid())
  productId    String
  warehouseId  String
  locationId   String?
  quantity     Int    @default(0)
  reservedQty  Int    @default(0)
  availableQty Int    @default(0)

  product   Product    @relation(fields: [productId], references: [id])
  warehouse Warehouse  @relation(fields: [warehouseId], references: [id])
  location  Location?  @relation(fields: [locationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, warehouseId, locationId])
  @@map("stock_levels")
}

model StockMovement {
  id            String            @id @default(cuid())
  productId     String
  warehouseId   String
  locationId    String?
  movementType  StockMovementType
  quantity      Int
  unitCost      Decimal?          @db.Decimal(15, 2)
  reference     String?           // Purchase Order, Sales Order, etc
  notes         String?
  performedBy   String?

  product   Product    @relation(fields: [productId], references: [id])
  warehouse Warehouse  @relation(fields: [warehouseId], references: [id])
  location  Location?  @relation(fields: [locationId], references: [id])

  createdAt DateTime @default(now())

  @@map("stock_movements")
}

enum StockMovementType {
  IN          // Stock masuk
  OUT         // Stock keluar
  ADJUSTMENT  // Penyesuaian stok
  TRANSFER    // Transfer antar lokasi
  RESERVED    // Reservasi stok
  RELEASED    // Pelepasan reservasi
}

// ================================
// Stock Alerts & Notifications
// ================================

model StockAlert {
  id        String           @id @default(cuid())
  productId String
  alertType StockAlertType
  threshold Int
  isActive  Boolean          @default(true)

  product Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stock_alerts")
}

enum StockAlertType {
  LOW_STOCK
  OUT_OF_STOCK
  OVERSTOCK
  EXPIRY_WARNING
}

// ================================
// Sales & CRM Module
// ================================

// Customer Categories
model CustomerCategory {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  description String?
  isActive    Boolean @default(true)

  customers Customer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customer_categories")
}

// Customer Master Data
model Customer {
  id               String                @id @default(cuid())
  code             String                @unique
  name             String
  legalName        String?
  customerType     CustomerType
  categoryId       String?
  
  // Indonesian Business Information
  npwp             String?               // Nomor Pokok Wajib Pajak
  nik              String?               // NIK (for individual)
  taxAddress       String?
  isTaxable        Boolean               @default(true)
  taxStatus        TaxStatus             @default(PKP)
  
  // E-Faktur Integration
  eFakturCredentials Json?               // Store encrypted e-faktur credentials
  
  // Contact Information
  phone            String?
  email            String?
  website          String?
  
  // Credit Management
  creditLimit      Decimal               @default(0) @db.Decimal(15, 2)
  creditTerm       Int                   @default(30) // days
  paymentTerm      PaymentTerm           @default(NET_30)
  creditStatus     CreditStatus          @default(GOOD)
  
  // Business Settings
  currency         String                @default("IDR")
  priceListId      String?
  salesPersonId    String?
  
  // Status & Flags
  isActive         Boolean               @default(true)
  isProspect       Boolean               @default(false)
  lastOrderDate    DateTime?
  totalOrderValue  Decimal               @default(0) @db.Decimal(15, 2)
  
  // Relations
  category         CustomerCategory?     @relation(fields: [categoryId], references: [id])
  priceList        PriceList?            @relation(fields: [priceListId], references: [id])
  salesPerson      User?                 @relation(fields: [salesPersonId], references: [id])
  
  // Related entities
  addresses        CustomerAddress[]
  contacts         CustomerContact[]
  quotations       Quotation[]
  salesOrders      SalesOrder[]
  creditNotes      CreditNote[]
  leads            Lead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

// Customer Addresses (Indonesian format)
model CustomerAddress {
  id           String      @id @default(cuid())
  customerId   String
  type         AddressType @default(BILLING)
  
  // Address Components
  address1     String
  address2     String?
  kelurahan    String?
  kecamatan    String?
  kabupaten    String
  provinsi     String
  postalCode   String
  country      String      @default("Indonesia")
  
  // Flags
  isPrimary    Boolean     @default(false)
  isActive     Boolean     @default(true)
  
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customer_addresses")
}

// Customer Contacts
model CustomerContact {
  id          String  @id @default(cuid())
  customerId  String
  
  // Contact Information
  name        String
  title       String?
  department  String?
  phone       String?
  mobile      String?
  email       String?
  
  // Flags
  isPrimary   Boolean @default(false)
  isActive    Boolean @default(true)
  
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customer_contacts")
}

// Price Lists
model PriceList {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  description String?
  currency    String  @default("IDR")
  isActive    Boolean @default(true)
  
  customers   Customer[]
  priceItems  PriceListItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("price_lists")
}

// Price List Items
model PriceListItem {
  id          String    @id @default(cuid())
  priceListId String
  productId   String
  price       Decimal   @db.Decimal(15, 2)
  minQty      Int       @default(1)
  validFrom   DateTime?
  validTo     DateTime?
  isActive    Boolean   @default(true)
  
  priceList PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([priceListId, productId])
  @@map("price_list_items")
}

// Quotations
model Quotation {
  id               String           @id @default(cuid())
  number           String           @unique
  customerId       String
  customerRef      String?
  
  // Dates
  quotationDate    DateTime         @default(now())
  validUntil       DateTime
  
  // Terms
  paymentTerm      PaymentTerm      @default(NET_30)
  deliveryTerm     String?
  
  // Amounts
  subtotal         Decimal          @default(0) @db.Decimal(15, 2)
  taxAmount        Decimal          @default(0) @db.Decimal(15, 2)
  discountAmount   Decimal          @default(0) @db.Decimal(15, 2)
  total            Decimal          @default(0) @db.Decimal(15, 2)
  
  // Status
  status           QuotationStatus  @default(DRAFT)
  
  // Notes
  notes            String?
  internalNotes    String?
  
  // Relations
  customer         Customer         @relation(fields: [customerId], references: [id])
  items            QuotationItem[]
  salesOrders      SalesOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("quotations")
}

// Quotation Items
model QuotationItem {
  id           String    @id @default(cuid())
  quotationId  String
  productId    String
  
  description  String?
  quantity     Decimal   @db.Decimal(10, 3)
  unitPrice    Decimal   @db.Decimal(15, 2)
  discount     Decimal   @default(0) @db.Decimal(5, 2) // percentage
  taxRate      Decimal   @default(11) @db.Decimal(5, 2) // PPN 11%
  lineTotal    Decimal   @db.Decimal(15, 2)
  
  product   Product   @relation(fields: [productId], references: [id])
  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("quotation_items")
}

// Sales Orders
model SalesOrder {
  id               String          @id @default(cuid())
  number           String          @unique
  customerId       String
  quotationId      String?
  customerRef      String?
  
  // Dates
  orderDate        DateTime        @default(now())
  requestedDate    DateTime?
  confirmedDate    DateTime?
  
  // Terms
  paymentTerm      PaymentTerm     @default(NET_30)
  deliveryTerm     String?
  
  // Amounts
  subtotal         Decimal         @default(0) @db.Decimal(15, 2)
  taxAmount        Decimal         @default(0) @db.Decimal(15, 2)
  discountAmount   Decimal         @default(0) @db.Decimal(15, 2)
  total            Decimal         @default(0) @db.Decimal(15, 2)
  
  // Status
  status           SalesOrderStatus @default(DRAFT)
  
  // Notes
  notes            String?
  internalNotes    String?
  
  // Relations
  customer         Customer        @relation(fields: [customerId], references: [id])
  quotation        Quotation?      @relation(fields: [quotationId], references: [id])
  items            SalesOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sales_orders")
}

// Sales Order Items
model SalesOrderItem {
  id            String     @id @default(cuid())
  salesOrderId  String
  productId     String
  
  description   String?
  quantity      Decimal    @db.Decimal(10, 3)
  unitPrice     Decimal    @db.Decimal(15, 2)
  discount      Decimal    @default(0) @db.Decimal(5, 2) // percentage
  taxRate       Decimal    @default(11) @db.Decimal(5, 2) // PPN 11%
  lineTotal     Decimal    @db.Decimal(15, 2)
  
  // Delivery tracking
  qtyDelivered  Decimal    @default(0) @db.Decimal(10, 3)
  qtyInvoiced   Decimal    @default(0) @db.Decimal(10, 3)
  
  product    Product    @relation(fields: [productId], references: [id])
  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sales_order_items")
}

// Leads Management
model Lead {
  id            String     @id @default(cuid())
  customerId    String?
  
  // Lead Information
  title         String
  description   String?
  source        LeadSource @default(WEBSITE)
  status        LeadStatus @default(NEW)
  priority      Priority   @default(MEDIUM)
  
  // Contact Information
  contactName   String
  contactEmail  String?
  contactPhone  String?
  company       String?
  
  // Sales Information
  estimatedValue Decimal?  @db.Decimal(15, 2)
  probability    Int       @default(0) // 0-100%
  expectedClose  DateTime?
  
  // Assignment
  assignedTo     String?
  
  // Relations
  customer       Customer? @relation(fields: [customerId], references: [id])
  assignee       User?     @relation(fields: [assignedTo], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("leads")
}

// Credit Notes
model CreditNote {
  id           String          @id @default(cuid())
  number       String          @unique
  customerId   String
  
  // Reference
  reference    String?         // Invoice or SO reference
  reason       CreditReason
  
  // Amounts
  amount       Decimal         @db.Decimal(15, 2)
  taxAmount    Decimal         @default(0) @db.Decimal(15, 2)
  total        Decimal         @db.Decimal(15, 2)
  
  // Status
  status       CreditNoteStatus @default(DRAFT)
  
  // Dates
  issueDate    DateTime        @default(now())
  
  // Notes
  notes        String?
  
  customer Customer @relation(fields: [customerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("credit_notes")
}

// ================================
// Sales & CRM Enums
// ================================

enum CustomerType {
  INDIVIDUAL    // Perorangan
  COMPANY       // Perusahaan
  GOVERNMENT    // Instansi Pemerintah
}

enum TaxStatus {
  PKP           // Pengusaha Kena Pajak
  NON_PKP       // Non PKP
  EXEMPT        // Bebas Pajak
}

enum PaymentTerm {
  CASH          // Tunai
  NET_15        // 15 hari
  NET_30        // 30 hari
  NET_45        // 45 hari
  NET_60        // 60 hari
  NET_90        // 90 hari
  COD           // Cash on Delivery
}

enum CreditStatus {
  GOOD          // Baik
  WATCH         // Perlu Perhatian
  HOLD          // Ditahan
  BLOCKED       // Diblokir
}

enum AddressType {
  BILLING       // Penagihan
  SHIPPING      // Pengiriman
  OFFICE        // Kantor
  WAREHOUSE     // Gudang
}

enum QuotationStatus {
  DRAFT         // Draft
  SENT          // Terkirim
  ACCEPTED      // Diterima
  REJECTED      // Ditolak
  EXPIRED       // Kedaluwarsa
  CONVERTED     // Dikonversi ke SO
}

enum SalesOrderStatus {
  DRAFT         // Draft
  CONFIRMED     // Dikonfirmasi
  IN_PROGRESS   // Dalam Proses
  DELIVERED     // Terkirim
  INVOICED      // Ditagih
  COMPLETED     // Selesai
  CANCELLED     // Dibatalkan
}

enum LeadSource {
  WEBSITE       // Website
  REFERRAL      // Referensi
  ADVERTISEMENT // Iklan
  COLD_CALL     // Cold Call
  EXHIBITION    // Pameran
  SOCIAL_MEDIA  // Media Sosial
  EMAIL         // Email
  OTHER         // Lainnya
}

enum LeadStatus {
  NEW           // Baru
  CONTACTED     // Dihubungi
  QUALIFIED     // Terkualifikasi
  PROPOSAL      // Proposal
  NEGOTIATION   // Negosiasi
  WON           // Menang
  LOST          // Kalah
}

enum Priority {
  LOW           // Rendah
  MEDIUM        // Sedang
  HIGH          // Tinggi
  URGENT        // Mendesak
}

enum CreditReason {
  RETURN        // Retur Barang
  DISCOUNT      // Diskon Tambahan
  DAMAGED       // Barang Rusak
  OVERPAYMENT   // Kelebihan Bayar
  ADJUSTMENT    // Penyesuaian
  OTHER         // Lainnya
}

enum CreditNoteStatus {
  DRAFT         // Draft
  APPROVED      // Disetujui
  APPLIED       // Diterapkan
  CANCELLED     // Dibatalkan
}
